<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OwinoFurniStore</title>

  <!-- Parse SDK -->
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>

  <style>
    :root{
      --accent-1:#1e88e5; /* cool blue */
      --accent-2:#2dd4bf; /* mint */
      --muted:#6b7280;
      --card-shadow: 0 8px 30px rgba(15,23,42,0.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:#fff;color:#0b1220;-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px;margin:0}

    /* categories horizontal scroll */
    .cats{display:flex;gap:10px;padding:12px 0;overflow-x:auto}
    .cats::-webkit-scrollbar{display:none}
    .cat-btn{flex:0 0 auto;padding:10px 14px;border-radius:999px;border:1px solid rgba(30,136,229,0.08);background:#f7fbff;color:var(--accent-1);font-weight:700;cursor:pointer;white-space:nowrap}
    .cat-btn.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;box-shadow:0 6px 20px rgba(30,136,229,0.12)}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(2, 1fr); gap: 16px;}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--card-shadow);overflow:hidden;border:1px solid #f3f6fb;display:flex;flex-direction:column}
    .imgwrap{height:180px;background:#f6fbfc;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .imgwrap img{width:100%;height:100%;object-fit:cover}
    .card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700}
    .price{color:var(--accent-1);font-weight:800}
    .desc{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:auto}
    .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-order{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff}
    .btn-details{background:#fff;border:1px solid #e6eef2;color:#111}

    /* admin login button */
    .admin-open{margin-left:10px;padding:8px 12px;border-radius:10px;border:none;background:#111827;color:#fff;cursor:pointer;font-weight:700}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:none;align-items:center;justify-content:center;z-index:80;padding:20px}
    .modal{width:100%;max-width:820px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 24px 60px rgba(2,6,23,0.4);max-height:90vh;overflow:auto}
    .modal h2{margin:0 0 8px 0}
    .flex{display:flex;gap:10px;align-items:center}
    input[type="text"],input[type="password"],input[type="number"],select,textarea{width:100%;padding:10px;border:1px solid #e6eef2;border-radius:8px;font-size:14px}
    label{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .btn-primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn-ghost{background:#fff;border:1px solid #e6eef2;padding:8px 10px;border-radius:8px;cursor:pointer}

    .admin-controls{margin-top:12px}
    .admin-products{margin-top:12px;display:grid;gap:8px}

    .will {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}
.about {
  background:#4b5563;
  color:#d1d5db;
  padding:20px;
  border-radius:8px;
}
.about h2 {
  color:#16a34a;
}

    /* responsive */
    @media (max-width:640px){
      .imgwrap{height:140px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }

    @media ( min-width:800px) {
     .grid {grid-template-columns: repeat(4, 1fr);}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">OF</div>
        <div>
          <h1>OwinoFurniStore</h1>
          <p class="subtitle">Mahogany Quality furniture — indoors & outdoors</p>
        </div>
      </div>

      <div style="display:flex;align-items:center">
        <div class="muted" style="font-size:13px;margin-right:10px">Orders WhatsApp: <strong>0740106820</strong></div>
        <button id="openAdminBtn" class="admin-open">Admin Login</button>
      </div>
    </header>

    <!-- categories -->
    <div class="cats" id="categoryBar" aria-hidden="false"></div>

    <!-- product grid -->
    <main>
      <div id="productsGrid" class="grid"></div>
      <div class="will">
        <div class="about">
        <h2>Location</h2>
        <p>We have our physical shop in Nairobi around Magadi road.</br>
        You're welcome to us physicaly or order online via our website,</br>
      and we deliver only arond Nairobi.</p>
        </div>
        <div class="about">
         <h2>Payment & Working Days</h2>
         <p>Our shop is always open from monday to saturday 8am-7pm.</br>
        Payment is always after delivery.</p>
        <p>WhatsApp or Call:0740106820</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Admin modal (login -> admin panel) -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="modalTitle">Admin Login</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="logoutBtn" class="btn-ghost" style="display:none">Logout</button>
          <button id="closeModal" class="btn-ghost">Close</button>
        </div>
      </div>

      <!-- Login form -->
      <section id="loginSection" style="margin-top:12px">
        <p class="muted">Sign in with the Back4App admin account (username OR email).</p>
        <div style="display:grid;gap:8px;margin-top:8px">
          <label>Username or Email</label>
          <input id="loginId" type="text" placeholder="admin Email" />
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="password" />
          <div style="display:flex;gap:8px;align-items:center">
            <button id="loginBtn" class="btn-primary">Login</button>
            <div id="loginMsg" class="muted" style="font-size:13px"></div>
          </div>
        </div>
      </section>

      <!-- Admin controls: visible after login -->
      <section id="adminSection" style="display:none;margin-top:16px">
        <h3>Admin Panel — Add Product</h3>
        <div class="admin-controls">
          <div style="display:grid;grid-template-columns:1fr 140px 140px;gap:8px">
            <div>
              <label>Product Name</label>
              <input id="prodName" type="text" />
            </div>
            <div>
              <label>Price (KSh)</label>
              <input id="prodPrice" type="number" />
            </div>
            <div>
              <label>Category</label>
              <select id="prodCategory">
                <option>Outdoors</option>
                <option>Beds</option>
                <option>Sofas</option>
                <option>Storage</option>
                <option>Dining</option>
                <option>Tables</option>
              </select>
            </div>
          </div>

          <div style="margin-top:8px">
            <label>Description</label>
            <textarea id="prodDesc" rows="3"></textarea>
          </div>

          <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
            <div>
              <label>Image (required)</label><br>
              <input id="prodImage" type="file" accept="image/*" />
            </div>
            <div style="margin-left:auto">
              <button id="addProdBtn" class="btn-primary">Add Product</button>
            </div>
          </div>

          <div style="margin-top:16px">
            <h4>Your Products</h4>
            <div id="adminProducts" class="admin-products"></div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <script>
  /***********************
   CONFIG — Replace these
  ***********************/
  const APP_ID = 'Hab87vFvsRx8L02uuGVm0qfKTTCxaP4tXlATJzGx';
  const JS_KEY = 'BPlkEj3nrbj1gGmz3yQuoe7CvQPNjUDgGqy1lvCq';
  const SERVER_URL = 'https://parseapi.back4app.com/'; // e.g. 'https://parseapi.back4app.com/'

  // initialize Parse
  Parse.initialize(APP_ID, JS_KEY);
  Parse.serverURL = SERVER_URL;

  /***********************
   Constants & UI refs
  ***********************/
  const CATS = ['All','Outdoors','Beds','Sofas','Storage','Dining','Tables'];
  const waNumber = '254740106820'; // Kenya +254 740106820
  const openAdminBtn = document.getElementById('openAdminBtn');
  const modal = document.getElementById('modal');
  const closeModal = document.getElementById('closeModal');
  const loginSection = document.getElementById('loginSection');
  const adminSection = document.getElementById('adminSection');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginId = document.getElementById('loginId');
  const loginPassword = document.getElementById('loginPassword');
  const loginMsg = document.getElementById('loginMsg');
  const addProdBtn = document.getElementById('addProdBtn');
  const adminProducts = document.getElementById('adminProducts');
  const productsGrid = document.getElementById('productsGrid');
  const categoryBar = document.getElementById('categoryBar');
  const modalTitle = document.getElementById('modalTitle');

  let activeCat = null; // null => All

  /***********************
   Build category bar
  ***********************/
  function buildCategories(){
    categoryBar.innerHTML = '';
    CATS.forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'cat-btn' + (cat === 'All' ? ' active' : '');
      b.textContent = cat;
      b.onclick = ()=> { selectCategory(cat === 'All' ? null : cat, b); };
      categoryBar.appendChild(b);
    });
  }

  function selectCategory(cat, btnEl){
    activeCat = cat;
    Array.from(categoryBar.children).forEach(ch => ch.classList.toggle('active', ch === btnEl));
    loadProducts();
  }

  /***********************
   Load products (home)
  ***********************/
  async function loadProducts(){
    productsGrid.innerHTML = '<div class="muted">Loading products…</div>';
    try {
      const Products = Parse.Object.extend('Products');
      const q = new Parse.Query(Products);
      if(activeCat) q.equalTo('category', activeCat);
      q.descending('createdAt');
      q.include('owner');
      const items = await q.find();
      renderProducts(items);
    } catch(err){
      console.error(err);
      productsGrid.innerHTML = '<div class="muted">Error loading products</div>';
    }
  }

  function renderProducts(items){
    productsGrid.innerHTML = '';
    if(!items.length){
      productsGrid.innerHTML = '<div class="muted">No products yet.</div>';
      return;
    }
    items.forEach(obj=>{
      const url = obj.get('image') ? (typeof obj.get('image').url === 'function' ? obj.get('image').url() : obj.get('image').url) : '';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="imgwrap"><img src="${url || placeholderSVG()}" alt="product image" /></div>
        <div class="card-body">
          <div class="title">${escapeHtml(obj.get('name') || '')}</div>
          <div class="price">KSh ${escapeHtml(String(obj.get('price') ?? '0'))}</div>
          <div class="desc">${escapeHtml((obj.get('description') || '').slice(0,140))}</div>
          <div class="row">
            <button class="btn btn-order">Order</button>
            <button class="btn btn-details">Details</button>
          </div>
        </div>
      `;
      // Order button opens WhatsApp
      const orderBtn = card.querySelector('.btn-order');
      orderBtn.addEventListener('click', ()=> {
        const msg = encodeURIComponent(`Hello, I'd like to order "${obj.get('name')}" (KSh ${obj.get('price')}). Please advise availability and delivery options. - OwinoFurniStore`);
        window.open(`https://wa.me/${waNumber}?text=${msg}`, '_blank');
      });

      // Details button
      const detailsBtn = card.querySelector('.btn-details');
      detailsBtn.addEventListener('click', ()=> {
        alert(`Name: ${obj.get('name')}\nPrice: KSh ${obj.get('price')}\nCategory: ${obj.get('category')}\n\n${obj.get('description') || ''}`);
      });

      productsGrid.appendChild(card);
    });
  }

  function placeholderSVG(){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#f3f7fb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9aa7b6" font-size="20">No Image</text></svg>`);
  }

  function escapeHtml(text){
    return (text + '').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  /***********************
   Admin modal open/close
  ***********************/
  openAdminBtn.addEventListener('click', ()=> {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    // reset state
    showLoginForm();
  });

  closeModal.addEventListener('click', closeModalFn);
  modal.addEventListener('click', (ev)=> { if(ev.target === modal) closeModalFn(); });
  function closeModalFn(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  /***********************
   Admin Login
   Accepts username OR email
  ***********************/
  loginBtn.addEventListener('click', async ()=>{
    loginMsg.textContent = 'Signing in…';
    const id = loginId.value.trim();
    const pass = loginPassword.value;
    if(!id || !pass){ loginMsg.textContent = 'Enter username/email and password'; return; }

    try {
      // Try login as username first
      try {
        const user = await Parse.User.logIn(id, pass);
        onAdminLoggedIn(user);
        return;
      } catch(err){
        // try email lookup fallback
        console.log('login by username failed; trying by email if exists.');
      }

      // search by email
      const User = Parse.Object.extend('_User');
      const q = new Parse.Query(User);
      q.equalTo('email', id);
      const found = await q.first();
      if(!found) throw new Error('No user with that email/username');
      const username = found.get('username');
      const user2 = await Parse.User.logIn(username, pass);
      onAdminLoggedIn(user2);
    } catch(err){
      console.error(err);
      loginMsg.textContent = 'Login failed: ' + (err.message || err);
    }
  });

  function showLoginForm(){
    loginSection.style.display = 'block';
    adminSection.style.display = 'none';
    logoutBtn.style.display = 'none';
    modalTitle.textContent = 'Admin Login';
    loginMsg.textContent = '';
    loginId.value = '';
    loginPassword.value = '';
  }

  function onAdminLoggedIn(user){
    loginSection.style.display = 'none';
    adminSection.style.display = 'block';
    logoutBtn.style.display = 'inline-block';
    modalTitle.textContent = 'Admin Panel';
    loginMsg.textContent = '';
    // show admin owned products list
    loadAdminProducts();
  }

  logoutBtn.addEventListener('click', async ()=>{
    await Parse.User.logOut();
    showLoginForm();
  });

  /***********************
   Admin: Add product
  ***********************/
  addProdBtn.addEventListener('click', async ()=>{
    const name = document.getElementById('prodName').value.trim();
    const price = Number(document.getElementById('prodPrice').value);
    const desc = document.getElementById('prodDesc').value.trim();
    const category = document.getElementById('prodCategory').value;
    const fileInput = document.getElementById('prodImage').files[0];

    if(!name || !price || !desc || !category || !fileInput){
      alert('Please fill all fields and choose an image.');
      return;
    }
    addProdBtn.disabled = true;
    addProdBtn.textContent = 'Uploading...';

    try {
      // upload file
      const parseFile = new Parse.File(fileInput.name, fileInput);
      await parseFile.save();

      const Products = Parse.Object.extend('Products');
      const p = new Products();
      p.set('name', name);
      p.set('price', price);
      p.set('description', desc);
      p.set('category', category);
      p.set('image', parseFile);
      p.set('owner', Parse.User.current());

      await p.save();
      alert('Product saved.');
      // clear inputs
      document.getElementById('prodName').value = '';
      document.getElementById('prodPrice').value = '';
      document.getElementById('prodDesc').value = '';
      document.getElementById('prodImage').value = '';
      // refresh lists
      loadProducts();
      loadAdminProducts();
    } catch(err){
      console.error(err);
      alert('Error saving product: ' + (err.message || err));
    } finally {
      addProdBtn.disabled = false;
      addProdBtn.textContent = 'Add Product';
    }
  });

  /***********************
   Admin: Load and Delete admin's products
  ***********************/
  async function loadAdminProducts(){
    adminProducts.innerHTML = '<div class="muted">Loading…</div>';
    try {
      const Products = Parse.Object.extend('Products');
      const q = new Parse.Query(Products);
      // show only owner products for this admin user
      q.equalTo('owner', Parse.User.current());
      q.descending('createdAt');
      const items = await q.find();
      renderAdminProducts(items);
    } catch(err){
      console.error(err);
      adminProducts.innerHTML = '<div class="muted">Error loading admin products</div>';
    }
  }

  function renderAdminProducts(items){
    adminProducts.innerHTML = '';
    if(!items.length){
      adminProducts.innerHTML = '<div class="muted">You have no products yet.</div>';
      return;
    }
    items.forEach(obj=>{
      const el = document.createElement('div');
      el.style.display='flex';
      el.style.justifyContent='space-between';
      el.style.alignItems='center';
      el.style.padding='8px';
      el.style.border='1px solid #f1f5f9';
      el.style.borderRadius='8px';
      el.style.marginBottom='8px';
      el.innerHTML = `<div><strong>${escapeHtml(obj.get('name')||'')}</strong><div class="muted">KSh ${escapeHtml(String(obj.get('price')||'0'))} • ${escapeHtml(obj.get('category')||'')}</div></div>`;
      const del = document.createElement('button');
      del.className = 'btn-ghost';
      del.style.background = '#fee2e2';
      del.style.border = '1px solid #fca5a5';
      del.style.color = '#b91c1c';
      del.style.borderRadius = '8px';
      del.style.padding = '8px 10px';
      del.style.cursor = 'pointer';
      del.textContent = 'Delete';
      del.onclick = async ()=>{
        if(!confirm(`Delete "${obj.get('name')}"?`)) return;
        try {
          await obj.destroy();
          alert('Deleted.');
          loadAdminProducts();
          loadProducts();
        } catch(e){
          alert('Delete failed: ' + (e.message || e));
        }
      };
      el.appendChild(del);
      adminProducts.appendChild(el);
    });
  }

  /***********************
   Init
  ***********************/
  buildCategories();
  loadProducts();

  // restore current user if session exists (keeps admin logged in across reloads)
  (function restoreUser(){
    const user = Parse.User.current();
    if(user){
      // but don't automatically open modal - user must click Admin Login to see panel
      console.log('Session active for', user.get('username') || user.id);
    }
  })();

  </script>
</body>
</html>
